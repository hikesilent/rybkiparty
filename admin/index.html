<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #f6f8fa;
        }
        #app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .panel {
            display: none;
            flex: 1;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }
        #login-panel {
            justify-content: center;
            text-align: center;
        }
        #cms-panel {
            width: 100%;
        }
        .btn {
            background: #24292e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin: 1rem 0;
        }
        .loading {
            margin: 2rem;
            color: #586069;
        }
        .error {
            color: #cb2431;
            margin: 1rem 0;
        }
        #cms-root {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="login-panel" class="panel">
            <h1>Admin Dashboard</h1>
            <button id="login-btn" class="btn">Login with GitHub</button>
            <div id="login-error" class="error"></div>
            <div id="login-loading" class="loading" style="display: none;">Loading...</div>
        </div>

        <div id="cms-panel" class="panel">
            <button id="logout-btn" class="btn">Logout</button>
            <div id="cms-loading" class="loading">Loading CMS...</div>
            <div id="cms-root"></div>
        </div>
    </div>

    <script>
        // Konfiguracja Firebase
        const firebaseConfig = {
      apiKey: "AIzaSyDv8zijZhIP3ceuGEyGI2RA4OSnh9iXqHc",
      authDomain: "rybki-party.firebaseapp.com",
      projectId: "rybki-party",
      storageBucket: "rybki-party.appspot.com",
      messagingSenderId: "985551857623",
      appId: "1:985551857623:web:5b66f04f0708c3feca0d92",
      measurementId: "G-G8KF8YWEP0"
        };

        // Globalny stan
        const state = {
            cmsInitialized: false,
            cmsInstance: null
        };

        // Inicjalizacja Firebase
        function initFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                setupAuth();
            } catch (error) {
                showError('login-error', `Firebase error: ${error.message}`);
            }
        }

        // Obsługa autentykacji
        function setupAuth() {
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');

            loginBtn.addEventListener('click', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);

            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    showCmsPanel();
                    initCMS();
                } else {
                    showLoginPanel();
                    destroyCMS();
                }
            });
        }

        // Logowanie
        async function handleLogin() {
            showLoading('login-loading');
            clearError('login-error');

            try {
                const provider = new firebase.auth.GithubAuthProvider();
                await firebase.auth().signInWithPopup(provider);
            } catch (error) {
                showError('login-error', `Login failed: ${error.message}`);
            } finally {
                hideLoading('login-loading');
            }
        }

        // Wylogowanie
        function handleLogout() {
            firebase.auth().signOut();
        }

        // Inicjalizacja CMS
        function initCMS() {
            if (state.cmsInitialized) return;

            showLoading('cms-loading');

            const script = document.createElement('script');
            script.src = 'https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js';
            script.onload = () => {
                try {
                    // Poczekaj, aż CMS będzie zdefiniowany
                    const checkCMS = setInterval(() => {
                        if (cmsFrame.contentWindow.CMS) {
                            clearInterval(checkCMS); // Zatrzymaj sprawdzanie
                            const cmsFrame = document.createElement('iframe');
                            cmsFrame.style.display = 'none';
                            cmsFrame.setAttribute('allow-scripts', 'true'); // Dodaj atrybut
                            document.body.appendChild(cmsFrame);

                            cmsFrame.contentWindow.CMS.init();
                            state.cmsInstance = cmsFrame;
                            state.cmsInitialized = true;

                            hideLoading('cms-loading');
                        }
                    }, 100); // Sprawdzaj co 100ms
                } catch (error) {
                    showError('cms-root', `CMS error: ${error.message}`);
                }
            };

            script.onerror = () => {
                showError('cms-root', 'Failed to load CMS');
            };

            document.head.appendChild(script);
        }

        // Niszczenie CMS
        function destroyCMS() {
            if (state.cmsInstance) {
                document.body.removeChild(state.cmsInstance);
                state.cmsInstance = null;
            }
            state.cmsInitialized = false;
            document.getElementById('cms-root').innerHTML = '';
        }

        // Pokazanie panelu logowania
        function showLoginPanel() {
            document.getElementById('login-panel').style.display = 'flex';
            document.getElementById('cms-panel').style.display = 'none';
        }

        // Pokazanie panelu CMS
        function showCmsPanel() {
            document.getElementById('login-panel').style.display = 'none';
            document.getElementById('cms-panel').style.display = 'flex';
        }

        // Pomocnicze funkcje UI
        function showLoading(id) {
            document.getElementById(id).style.display = 'block';
        }

        function hideLoading(id) {
            document.getElementById(id).style.display = 'none';
        }

        function showError(id, message) {
            const el = document.getElementById(id);
            el.textContent = message;
            el.style.display = 'block';
        }

        function clearError(id) {
            document.getElementById(id).style.display = 'none';
        }

        // Start aplikacji
        document.addEventListener('DOMContentLoaded', initFirebase);
    </script>
</body>
</html>